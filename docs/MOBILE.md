# Mobile App Integration with Capacitor

Comprehensive guide for adding native iOS/Android support to this template using **Capacitor**. Based on real-world experience building and testing on both platforms.

---

## Architecture: SSR (Web) + SPA Shell (Mobile)

This template uses TanStack Start for SSR on Cloudflare Workers. Capacitor needs static files. The solution is TanStack Start's **SPA Mode** — one build produces both outputs:

```
npm run build
  ├── SSR build → dist/server/    (deployed to Cloudflare Workers — web users)
  └── SPA shell → dist/client/    (bundled into native apps by Capacitor)
       └── index.html             (generated by SPA Mode prerender step)

npx cap sync → copies dist/client/* into:
  ├── ios/App/App/public/
  └── android/app/src/main/assets/public/
```

**Key insight**: Capacitor loads static files in a WebView — there is no server. Server functions (`createServerFn`) will fail. Auth and data fetching happen client-side via Convex's real-time WebSocket connection.

---

## Setup Guide

### 1. Enable SPA Mode in Vite Config

Add the `spa` option to the TanStack Start plugin:

```typescript
// vite.config.ts
tanstackStart({
  srcDirectory: 'src',
  start: { entry: './start.tsx' },
  server: { entry: './server.ts' },
  // SPA Mode: generates a static /index.html shell for Capacitor
  // The SSR build for Cloudflare Workers is unaffected
  spa: {
    enabled: true,
    prerender: {
      outputPath: '/index.html',  // Capacitor expects index.html
    },
  },
}),
```

### 2. Install Capacitor

```bash
npm install @capacitor/core @capacitor/cli
npx cap init "Your App Name" com.yourcompany.appname --web-dir dist/client
```

### 3. Add Platforms

```bash
npx cap add ios
npx cap add android
```

### 4. Platform Detection Utility

Create `src/lib/platform.ts`:

```typescript
import { Capacitor } from '@capacitor/core'

export function isNative(): boolean {
  return Capacitor.isNativePlatform()
}

export function isIOS(): boolean {
  return Capacitor.getPlatform() === 'ios'
}

export function isAndroid(): boolean {
  return Capacitor.getPlatform() === 'android'
}

export function isWeb(): boolean {
  return Capacitor.getPlatform() === 'web'
}
```

### 5. Fix Auth for Native

Auth requests on native apps must go directly to your Convex backend — there's no SSR server to proxy through.

```typescript
// src/lib/auth-client.ts
import { createAuthClient } from 'better-auth/react'
import { convexClient } from '@convex-dev/better-auth/client/plugins'
import { isNative } from './platform'

// Native: auth goes directly to Convex backend
// Web: relative origin (SSR proxies to Convex)
const baseURL = typeof window !== 'undefined' && isNative()
  ? import.meta.env.VITE_CONVEX_SITE_URL
  : undefined

export const authClient = createAuthClient({
  baseURL,
  plugins: [convexClient()],
})
```

### 6. Add Capacitor Origins to Trusted Origins

```typescript
// convex/auth.ts — in your Better Auth config
trustedOrigins: [
  'http://localhost:3000',
  'http://localhost:8787',
  // Capacitor WebView origins
  'capacitor://localhost',  // iOS (default WKWebView scheme)
  'https://localhost',      // Android (default scheme)
  envConfig.siteUrl,
],
```

### 7. Make Server Functions Gracefully Fail

Server functions (`createServerFn`) don't work in SPA/Capacitor mode. Wrap them in try/catch:

```typescript
// src/routes/__root.tsx
beforeLoad: async (ctx) => {
  // SSR mode: getAuth() fetches token server-side
  // SPA mode (Capacitor): fails gracefully, client-side auth takes over
  let token: string | null = null
  try {
    token = await getAuth()
  } catch {
    // Expected in SPA/Capacitor mode — no server available
  }

  if (token) {
    ctx.context.convexQueryClient.serverHttpClient?.setAuth(token)
  }

  return { isAuthenticated: !!token, token }
},
```

### 8. Build, Sync, and Run

```bash
npm run build          # Builds SSR + SPA shell
npx cap sync           # Copies dist/client/* to native projects
npx cap open ios       # Opens Xcode
npx cap open android   # Opens Android Studio
```

---

## Capacitor Configuration

```typescript
// capacitor.config.ts
import type { CapacitorConfig } from '@capacitor/cli'

const config: CapacitorConfig = {
  appId: 'com.yourcompany.appname',
  appName: 'Your App',
  webDir: 'dist/client',
  server: {
    // iOS uses 'capacitor' scheme by default (WKWebView requirement)
    // Android uses 'https' scheme by default
    // Do NOT set iosScheme to 'http' or 'https' — WKWebView can't handle those
    hostname: 'localhost',
  },
}

export default config
```

### Important: iOS Scheme Limitation

WKWebView on iOS **cannot** use `http://` or `https://` as custom URL schemes. The Capacitor docs explicitly state this. Keep the default `capacitor://localhost` for iOS or your auth client will crash with `BetterAuthError: Invalid base URL`.

---

## Native Plugins

### Camera

```bash
npm install @capacitor/camera
```

**Required: iOS Privacy Descriptions** — Add to `ios/App/App/Info.plist`:
```xml
<key>NSCameraUsageDescription</key>
<string>This app needs camera access to take photos</string>
<key>NSPhotoLibraryUsageDescription</key>
<string>This app needs photo library access to upload images</string>
```

**Required: Android Permissions** — Should be auto-configured by Capacitor, but verify in `android/app/src/main/AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
```

### Geolocation

```bash
npm install @capacitor/geolocation
```

**iOS**: Add to Info.plist:
```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>This app uses your location to find nearby items</string>
```

### Share

```bash
npm install @capacitor/share
```

---

## Known Issues & Workarounds

### Android Gradle Plugin 9.x+ ProGuard Error

**Problem**: Capacitor v8 plugins use deprecated `proguard-android.txt`, causing build failures with AGP 9.x+:
```
`getDefaultProguardFile('proguard-android.txt')` is no longer supported
```

**Fix**: Create `scripts/patch-capacitor-android.sh`:
```bash
#!/bin/bash
set -e
echo "Patching Capacitor Android plugins for AGP 9.x compatibility..."

for plugin in node_modules/@capacitor/*/android/build.gradle; do
  if [ -f "$plugin" ]; then
    sed -i '' "s/proguard-android\.txt/proguard-android-optimize.txt/g" "$plugin"
    echo "  ✓ Patched $plugin"
  fi
done

echo "✅ All Capacitor Android plugins patched"
```

Add to `package.json`:
```json
"scripts": {
  "postinstall": "bash scripts/patch-capacitor-android.sh"
}
```

### Safe Area Insets (Status Bar / Notch)

Mobile devices have status bars, notches, and home indicators that overlap content. Handle with CSS:

```css
/* In your root layout / globals.css */
.top-bar {
  padding-top: env(safe-area-inset-top);
}

.bottom-nav {
  padding-bottom: env(safe-area-inset-bottom);
}
```

Also ensure the viewport meta tag includes `viewport-fit=cover`:
```html
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
```

### Lock Orientation to Portrait

Most mobile-first apps should lock to portrait:

**iOS**: In Xcode → Target → General → Deployment Info → uncheck Landscape Left and Landscape Right

**Android**: In `android/app/src/main/AndroidManifest.xml`:
```xml
<activity android:screenOrientation="portrait" ...>
```

### OAuth / Sign-In on Native

Google OAuth blocks embedded WebViews. The solution uses `better-auth-capacitor` to open OAuth in the **system browser** (Safari/Chrome) and handle the callback via deep links.

#### Install Dependencies

```bash
npm install better-auth-capacitor @capacitor/preferences @capacitor/app
```

#### Deep Link Setup

Register a custom URL scheme (e.g., `yourapp://`):

**iOS** — `ios/App/App/Info.plist`:
```xml
<key>CFBundleURLTypes</key>
<array>
  <dict>
    <key>CFBundleURLSchemes</key>
    <array>
      <string>yourapp</string>
    </array>
  </dict>
</array>
```

**Android** — `android/app/src/main/AndroidManifest.xml`:
```xml
<intent-filter>
  <action android:name="android.intent.action.VIEW" />
  <category android:name="android.intent.category.DEFAULT" />
  <category android:name="android.intent.category.BROWSABLE" />
  <data android:scheme="yourapp" />
</intent-filter>
```

#### Server Config (`convex/auth.ts`)

```typescript
import { capacitor } from 'better-auth-capacitor'

const auth = betterAuth({
  baseURL: process.env.CONVEX_SITE_URL,  // NOT SITE_URL — must be the actual Convex HTTP URL
  trustedOrigins: [
    'capacitor://localhost',     // iOS WebView
    'https://localhost',         // Android WebView
    'yourapp://',                // Deep link scheme
  ],
  plugins: [convex({ authConfig }), capacitor()],
})
```

**Important**: Use `process.env.CONVEX_SITE_URL` (the Convex HTTP endpoint like `https://xxx.convex.site`), not `SITE_URL` (which is typically `http://localhost:3000` in dev). OAuth redirects go to this URL on the phone — it must be publicly accessible.

#### Client Config (`src/lib/auth-client.ts`)

```typescript
import { withCapacitor } from 'better-auth-capacitor/client'
import { isNative } from '@/lib/platform'

const authClient = createAuthClient(withCapacitor({
  baseURL: isNative() ? import.meta.env.VITE_CONVEX_SITE_URL : undefined,
  plugins: [convexClient()],
}, {
  scheme: 'yourapp',               // Must match Info.plist / AndroidManifest
  storagePrefix: 'better-auth',
}))
```

#### The Convex Cookie Bridge (`convex/http.ts`)

**This is critical.** The `capacitor()` plugin uses after-hooks to inject `set-cookie` into the OAuth redirect URL. However, in Convex runtime, Better Auth throws an `APIError` with status 302 for redirects, which **bypasses all plugin after-hooks**. The cookie never gets injected and auth silently fails.

The fix is a Proxy wrapper at the HTTP layer that post-processes the Response:

```typescript
import { createAuth } from './auth'

// Proxy wrapper: injects set-cookie as ?cookie= param on native redirects
function createAuthWithNativeBridge(ctx: any) {
  const auth = createAuth(ctx)
  return new Proxy(auth, {
    get(target, prop, receiver) {
      if (prop === 'handler') {
        const originalHandler = Reflect.get(target, prop, receiver)
        return async (request: Request) => {
          const response = await originalHandler(request)
          if (response.status >= 300 && response.status < 400) {
            const location = response.headers.get('location')
            const setCookie = response.headers.get('set-cookie')
            // Only intercept redirects to non-HTTP schemes (yourapp://)
            if (location && setCookie && !location.startsWith('http')) {
              const sessionMatch = setCookie.match(
                /(?:__Secure-)?better-auth\.session_token=([^;]+)/
              )
              if (sessionMatch) {
                const separator = location.includes('?') ? '&' : '?'
                const newLocation = `${location}${separator}cookie=${encodeURIComponent(
                  `__Secure-better-auth.session_token=${sessionMatch[1]}`
                )}`
                return new Response(null, {
                  status: response.status,
                  headers: { ...Object.fromEntries(response.headers), location: newLocation },
                })
              }
            }
          }
          return response
        }
      }
      return Reflect.get(target, prop, receiver)
    },
  })
}

// Register routes with the bridge wrapper instead of plain createAuth
authComponent.registerRoutes(http, createAuthWithNativeBridge, {
  cors: {
    allowedHeaders: ['capacitor-origin', 'x-skip-oauth-proxy'],
    exposedHeaders: ['set-auth-token'],
  },
})
```

#### CORS for Capacitor

The `registerRoutes()` call **must** include `cors` options. Without it, Capacitor WebView cross-origin requests fail silently (no OPTIONS handler).

#### Google Cloud Console

Add `{CONVEX_SITE_URL}/api/auth/callback/google` as an **Authorized redirect URI** in the Google Cloud Console OAuth 2.0 client settings.

#### How It Works (End-to-End)

```
1. App calls signIn.social({ provider: 'google' })
2. better-auth-capacitor opens system browser via ASWebAuthenticationSession (iOS)
3. Browser → Google OAuth → redirects to CONVEX_SITE_URL/api/auth/callback/google
4. Better Auth processes callback, creates session, returns 302 with set-cookie + location: yourapp://auth/callback
5. Cookie Bridge Proxy intercepts the 302, reads set-cookie, appends ?cookie=... to the redirect URL
6. System browser follows redirect → yourapp://auth/callback?cookie=session_token_value
7. better-auth-capacitor receives deep link, stores session in @capacitor/preferences
8. Auth complete — user is signed in
```

#### Gotchas

- **APIError bypass**: Better Auth's 302 is an `APIError`, not a normal Response — plugin after-hooks never run in Convex. The HTTP-layer Proxy is the only reliable fix.
- **Cookie name varies**: In production (HTTPS), the cookie is `__Secure-better-auth.session_token`. In dev, it's `better-auth.session_token`. The regex handles both.
- **`Reflect.get` is required**: The Proxy must use `Reflect.get(target, prop, receiver)` for non-handler properties to preserve Convex's `$context` getter (which is a getter, not a plain property).
- **signIn.social returns immediately on native**: The function returns while the system browser is still open. Check `result.error` for pre-redirect failures, but a missing `result.data` is normal on native.

---

## Development Workflow

```bash
# After code changes:
npm run build && npx cap sync

# Then press Run (▶) in Xcode or Android Studio

# For faster iteration during development, use live reload:
# (In capacitor.config.ts, temporarily add:)
server: {
  url: 'http://YOUR_LOCAL_IP:3000',  // Your dev machine's IP
  cleartext: true,
}
# Then just run `npm run dev` — changes reflect instantly in the native app
# ⚠️ Remove this before building for production!
```

---

## Checklist

- [ ] Enable SPA mode in `vite.config.ts`
- [ ] Install Capacitor core + CLI
- [ ] Add iOS and Android platforms
- [ ] Create platform detection utility (`src/lib/platform.ts`)
- [ ] Update `auth-client.ts` with native baseURL
- [ ] Add Capacitor origins to `trustedOrigins` in `convex/auth.ts`
- [ ] Wrap `getAuth()` server function in try/catch for SPA fallback
- [ ] Add iOS privacy descriptions to Info.plist (camera, location, photos)
- [ ] Create ProGuard patch script for Android
- [ ] Add safe area inset CSS for status bar / notch / home indicator
- [ ] Lock orientation to portrait
- [ ] Configure OAuth flow for native (see "OAuth / Sign-In on Native" section above)
- [ ] Test on real devices (simulator has camera/GPS limitations)
