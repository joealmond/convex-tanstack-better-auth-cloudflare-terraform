# Mobile App Integration with Capacitor

Comprehensive guide for adding native iOS/Android support to this template using **Capacitor**. Based on real-world experience building and testing on both platforms.

---

## Architecture: SSR (Web) + SPA Shell (Mobile)

This template uses TanStack Start for SSR on Cloudflare Workers. Capacitor needs static files. The solution is TanStack Start's **SPA Mode** — one build produces both outputs:

```
npm run build
  ├── SSR build → dist/server/    (deployed to Cloudflare Workers — web users)
  └── SPA shell → dist/client/    (bundled into native apps by Capacitor)
       └── index.html             (generated by SPA Mode prerender step)

npx cap sync → copies dist/client/* into:
  ├── ios/App/App/public/
  └── android/app/src/main/assets/public/
```

**Key insight**: Capacitor loads static files in a WebView — there is no server. Server functions (`createServerFn`) will fail. Auth and data fetching happen client-side via Convex's real-time WebSocket connection.

---

## Setup Guide

### 1. Enable SPA Mode in Vite Config

Add the `spa` option to the TanStack Start plugin:

```typescript
// vite.config.ts
tanstackStart({
  srcDirectory: 'src',
  start: { entry: './start.tsx' },
  server: { entry: './server.ts' },
  // SPA Mode: generates a static /index.html shell for Capacitor
  // The SSR build for Cloudflare Workers is unaffected
  spa: {
    enabled: true,
    prerender: {
      outputPath: '/index.html',  // Capacitor expects index.html
    },
  },
}),
```

### 2. Install Capacitor

```bash
npm install @capacitor/core @capacitor/cli
npx cap init "Your App Name" com.yourcompany.appname --web-dir dist/client
```

### 3. Add Platforms

```bash
npx cap add ios
npx cap add android
```

### 4. Platform Detection Utility

Create `src/lib/platform.ts`:

```typescript
import { Capacitor } from '@capacitor/core'

export function isNative(): boolean {
  return Capacitor.isNativePlatform()
}

export function isIOS(): boolean {
  return Capacitor.getPlatform() === 'ios'
}

export function isAndroid(): boolean {
  return Capacitor.getPlatform() === 'android'
}

export function isWeb(): boolean {
  return Capacitor.getPlatform() === 'web'
}
```

### 5. Fix Auth for Native

Auth requests on native apps must go directly to your Convex backend — there's no SSR server to proxy through.

```typescript
// src/lib/auth-client.ts
import { createAuthClient } from 'better-auth/react'
import { convexClient } from '@convex-dev/better-auth/client/plugins'
import { isNative } from './platform'

// Native: auth goes directly to Convex backend
// Web: relative origin (SSR proxies to Convex)
const baseURL = typeof window !== 'undefined' && isNative()
  ? import.meta.env.VITE_CONVEX_SITE_URL
  : undefined

export const authClient = createAuthClient({
  baseURL,
  plugins: [convexClient()],
})
```

### 6. Add Capacitor Origins to Trusted Origins

```typescript
// convex/auth.ts — in your Better Auth config
trustedOrigins: [
  'http://localhost:3000',
  'http://localhost:8787',
  // Capacitor WebView origins
  'capacitor://localhost',  // iOS (default WKWebView scheme)
  'https://localhost',      // Android (default scheme)
  envConfig.siteUrl,
],
```

### 7. Make Server Functions Gracefully Fail

Server functions (`createServerFn`) don't work in SPA/Capacitor mode. Wrap them in try/catch:

```typescript
// src/routes/__root.tsx
beforeLoad: async (ctx) => {
  // SSR mode: getAuth() fetches token server-side
  // SPA mode (Capacitor): fails gracefully, client-side auth takes over
  let token: string | null = null
  try {
    token = await getAuth()
  } catch {
    // Expected in SPA/Capacitor mode — no server available
  }

  if (token) {
    ctx.context.convexQueryClient.serverHttpClient?.setAuth(token)
  }

  return { isAuthenticated: !!token, token }
},
```

### 8. Build, Sync, and Run

```bash
npm run build          # Builds SSR + SPA shell
npx cap sync           # Copies dist/client/* to native projects
npx cap open ios       # Opens Xcode
npx cap open android   # Opens Android Studio
```

---

## Capacitor Configuration

```typescript
// capacitor.config.ts
import type { CapacitorConfig } from '@capacitor/cli'

const config: CapacitorConfig = {
  appId: 'com.yourcompany.appname',
  appName: 'Your App',
  webDir: 'dist/client',
  server: {
    // iOS uses 'capacitor' scheme by default (WKWebView requirement)
    // Android uses 'https' scheme by default
    // Do NOT set iosScheme to 'http' or 'https' — WKWebView can't handle those
    hostname: 'localhost',
  },
}

export default config
```

### Important: iOS Scheme Limitation

WKWebView on iOS **cannot** use `http://` or `https://` as custom URL schemes. The Capacitor docs explicitly state this. Keep the default `capacitor://localhost` for iOS or your auth client will crash with `BetterAuthError: Invalid base URL`.

---

## Native Plugins

### Camera

```bash
npm install @capacitor/camera
```

**Required: iOS Privacy Descriptions** — Add to `ios/App/App/Info.plist`:
```xml
<key>NSCameraUsageDescription</key>
<string>This app needs camera access to take photos</string>
<key>NSPhotoLibraryUsageDescription</key>
<string>This app needs photo library access to upload images</string>
```

**Required: Android Permissions** — Should be auto-configured by Capacitor, but verify in `android/app/src/main/AndroidManifest.xml`:
```xml
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.READ_MEDIA_IMAGES" />
```

### Geolocation

```bash
npm install @capacitor/geolocation
```

**iOS**: Add to Info.plist:
```xml
<key>NSLocationWhenInUseUsageDescription</key>
<string>This app uses your location to find nearby items</string>
```

### Share

```bash
npm install @capacitor/share
```

---

## Known Issues & Workarounds

### Android Gradle Plugin 9.x+ ProGuard Error

**Problem**: Capacitor v8 plugins use deprecated `proguard-android.txt`, causing build failures with AGP 9.x+:
```
`getDefaultProguardFile('proguard-android.txt')` is no longer supported
```

**Fix**: Create `scripts/patch-capacitor-android.sh`:
```bash
#!/bin/bash
set -e
echo "Patching Capacitor Android plugins for AGP 9.x compatibility..."

for plugin in node_modules/@capacitor/*/android/build.gradle; do
  if [ -f "$plugin" ]; then
    sed -i '' "s/proguard-android\.txt/proguard-android-optimize.txt/g" "$plugin"
    echo "  ✓ Patched $plugin"
  fi
done

echo "✅ All Capacitor Android plugins patched"
```

Add to `package.json`:
```json
"scripts": {
  "postinstall": "bash scripts/patch-capacitor-android.sh"
}
```

### Safe Area Insets (Status Bar / Notch)

Mobile devices have status bars, notches, and home indicators that overlap content. Handle with CSS:

```css
/* In your root layout / globals.css */
.top-bar {
  padding-top: env(safe-area-inset-top);
}

.bottom-nav {
  padding-bottom: env(safe-area-inset-bottom);
}
```

Also ensure the viewport meta tag includes `viewport-fit=cover`:
```html
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
```

### Lock Orientation to Portrait

Most mobile-first apps should lock to portrait:

**iOS**: In Xcode → Target → General → Deployment Info → uncheck Landscape Left and Landscape Right

**Android**: In `android/app/src/main/AndroidManifest.xml`:
```xml
<activity android:screenOrientation="portrait" ...>
```

### OAuth / Sign-In on Native

Google OAuth redirects won't work directly from `capacitor://localhost`. Options:

1. **In-App Browser**: Use `@capacitor/browser` to open OAuth flow in a system browser, then handle the callback via deep links / app URL scheme
2. **Custom scheme redirect**: Register a custom URL scheme and configure your OAuth provider to redirect to it
3. **Google Sign-In SDK**: Use `@codetrix-studio/capacitor-google-auth` for native Google Sign-In

This is the most complex part of Capacitor integration — plan for research time.

---

## Development Workflow

```bash
# After code changes:
npm run build && npx cap sync

# Then press Run (▶) in Xcode or Android Studio

# For faster iteration during development, use live reload:
# (In capacitor.config.ts, temporarily add:)
server: {
  url: 'http://YOUR_LOCAL_IP:3000',  // Your dev machine's IP
  cleartext: true,
}
# Then just run `npm run dev` — changes reflect instantly in the native app
# ⚠️ Remove this before building for production!
```

---

## Checklist

- [ ] Enable SPA mode in `vite.config.ts`
- [ ] Install Capacitor core + CLI
- [ ] Add iOS and Android platforms
- [ ] Create platform detection utility (`src/lib/platform.ts`)
- [ ] Update `auth-client.ts` with native baseURL
- [ ] Add Capacitor origins to `trustedOrigins` in `convex/auth.ts`
- [ ] Wrap `getAuth()` server function in try/catch for SPA fallback
- [ ] Add iOS privacy descriptions to Info.plist (camera, location, photos)
- [ ] Create ProGuard patch script for Android
- [ ] Add safe area inset CSS for status bar / notch / home indicator
- [ ] Lock orientation to portrait
- [ ] Configure OAuth flow for native (deep links or native SDK)
- [ ] Test on real devices (simulator has camera/GPS limitations)
